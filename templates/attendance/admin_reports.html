{% extends "base_user.html" %}
{% block title %}Attendance Reports - StaffHub{% endblock %}

{% block content %}
<div class="container-fluid py-5">
  <h2 class="mb-4">Attendance Reports</h2>

  <!-- Filters -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label for="staff" class="form-label">Staff</label>
          <input type="text" id="staff" name="staff" class="form-control"
                 placeholder="Search staff..." value="{{ request.GET.staff }}">
        </div>
        <div class="col-md-3">
          <label for="start_date" class="form-label">Start Date</label>
          <input type="date" id="start_date" name="start_date" class="form-control"
                 value="{{ request.GET.start_date }}">
        </div>
        <div class="col-md-3">
          <label for="end_date" class="form-label">End Date</label>
          <input type="date" id="end_date" name="end_date" class="form-control"
                 value="{{ request.GET.end_date }}">
        </div>
        <div class="col-md-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-fill">Filter</button>
          <a href="{% url 'attendance:export_csv' %}" class="btn btn-success flex-fill">CSV</a>
          <a href="{% url 'attendance:export_excel' %}" class="btn btn-accent flex-fill">Excel</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Attendance Chart -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Attendance Overview</h5>
      <div class="chart-container" style="height: 350px;">
        <canvas id="attendanceReportChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Report Table -->
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Staff</th>
              <th>Total Days</th>
              <th>Present</th>
              <th>Absent</th>
              <th>Attendance %</th>
            </tr>
          </thead>
          <tbody>
            {% for report in reports %}
            <tr>
              <td>{{ report.staff.username }}</td>
              <td>{{ report.total_days }}</td>
              <td>{{ report.present_days }}</td>
              <td>{{ report.absent_days }}</td>
              <td>{{ report.attendance_percentage }}%</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted py-4">
                No reports available.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const ctx = document.getElementById("attendanceReportChart").getContext("2d");

  const labels = [
    {% for report in reports %}
      "{{ report.staff.username }}",
    {% endfor %}
  ];

  const presentData = [
    {% for report in reports %}
      {{ report.present_days }},
    {% endfor %}
  ];

  const absentData = [
    {% for report in reports %}
      {{ report.absent_days }},
    {% endfor %}
  ];

  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Present Days",
          data: presentData,
          backgroundColor: "rgba(40, 167, 69, 0.8)", // StaffHub green
        },
        {
          label: "Absent Days",
          data: absentData,
          backgroundColor: "rgba(255, 193, 7, 0.8)", // StaffHub amber
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "top" },
      },
      scales: {
        x: { stacked: true },
        y: { stacked: true, beginAtZero: true }
      }
    }
  });
});
</script>
{% endblock %}
