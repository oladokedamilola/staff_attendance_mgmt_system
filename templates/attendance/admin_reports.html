{% extends "base_user.html" %}
{% block title %}Attendance Reports - StaffHub{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <h2 class="h4 fw-bold mb-4">Attendance Reports</h2>

  <!-- Filters -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      <input type="text" name="staff" class="form-control" placeholder="Search staff..." value="{{ request.GET.staff }}">
    </div>
    <div class="col-md-3">
      <input type="date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
    </div>
    <div class="col-md-3">
      <input type="date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
    </div>
    <div class="col-md-3 d-flex">
      <button type="submit" class="btn btn-outline-primary me-2 flex-fill">Filter</button>
      <a href="{% url 'attendance:export_csv' %}" class="btn btn-outline-success me-2 flex-fill">CSV</a>
      <a href="{% url 'attendance:export_excel' %}" class="btn btn-outline-info flex-fill">Excel</a>
    </div>
  </form>

  <!-- Attendance Chart -->
  <div class="card shadow-sm rounded-4 border-0 mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Attendance Overview</h5>
      <div class="chart-container" style="height: 350px;">
        <canvas id="attendanceReportChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Report Table -->
  <div class="card shadow-sm rounded-4 border-0">
    <div class="card-body">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Staff</th>
            <th>Total Days</th>
            <th>Present</th>
            <th>Absent</th>
            <th>Attendance %</th>
          </tr>
        </thead>
        <tbody>
          {% for report in reports %}
          <tr>
            <td>{{ report.staff.username }}</td>
            <td>{{ report.total_days }}</td>
            <td>{{ report.present_days }}</td>
            <td>{{ report.absent_days }}</td>
            <td>{{ report.attendance_percentage }}%</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center text-muted">No reports available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const ctx = document.getElementById("attendanceReportChart").getContext("2d");

  const labels = [
    {% for report in reports %}
      "{{ report.staff.username }}",
    {% endfor %}
  ];

  const presentData = [
    {% for report in reports %}
      {{ report.present_days }},
    {% endfor %}
  ];

  const absentData = [
    {% for report in reports %}
      {{ report.absent_days }},
    {% endfor %}
  ];

  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Present Days",
          data: presentData,
          backgroundColor: "rgba(40, 167, 69, 0.7)",
        },
        {
          label: "Absent Days",
          data: absentData,
          backgroundColor: "rgba(220, 53, 69, 0.7)",
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "top" },
      },
      scales: {
        x: { stacked: true },
        y: { stacked: true, beginAtZero: true }
      }
    }
  });
});
</script>
{% endblock %}
